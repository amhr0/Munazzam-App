# المساعد الخفي للمقابلات (Real-Time Interview Copilot)

## نظرة عامة

المساعد الخفي هو ميزة متقدمة تستخدم Socket.io والتعرف الصوتي المباشر لتقديم اقتراحات فورية أثناء إجراء المقابلات الوظيفية.

## الميزات الرئيسية

### 1. التقاط الصوت المباشر
- التقاط الصوت من المتصفح باستخدام MediaRecorder API
- دعم تنسيق WebM/Opus
- معالجة الصوت في chunks كل 5 ثوان للحصول على استجابة فورية

### 2. التعرف الصوتي الفوري
- تحويل الصوت إلى نص باستخدام Whisper API
- دعم اللغة العربية
- عرض النص المباشر في الواجهة

### 3. التحليل الذكي المباشر
- تحليل إجابات المرشح فور انتهائها
- استخدام RAG للحصول على سياق من الكتب الإدارية
- تقييم جودة الإجابات

### 4. الاقتراحات الفورية
- **أسئلة متابعة**: أسئلة مقترحة بناءً على إجابة المرشح
- **رؤى**: ملاحظات حول جودة الإجابة
- **مخاوف**: تحذيرات من نقاط ضعف محتملة

### 5. كشف العلامات الحمراء
- كشف التناقضات في الإجابات
- كشف الإجابات المبهمة أو التهرب
- تصنيف حسب الخطورة (منخفض، متوسط، عالي)

### 6. حفظ الجلسة
- حفظ النص الكامل للمقابلة
- حفظ جميع الاقتراحات والعلامات الحمراء
- إنشاء ملخص نهائي بالذكاء الاصطناعي

## البنية التقنية

### Backend (Socket.io)

```
server/services/liveCopilot.ts
├── initializeLiveCopilot()      # تهيئة Socket.io
├── generateInitialQuestions()   # توليد أسئلة افتتاحية
├── analyzeResponse()            # تحليل إجابة المرشح
├── generateSessionSummary()     # إنشاء ملخص الجلسة
└── saveSessionToDatabase()      # حفظ في قاعدة البيانات
```

**Events المدعومة:**
- `start-session`: بدء جلسة جديدة
- `audio-chunk`: إرسال chunk صوتي
- `end-session`: إنهاء الجلسة
- `transcription`: استقبال النص المحول
- `suggestions`: استقبال الاقتراحات
- `red-flags`: استقبال العلامات الحمراء
- `session-ended`: استقبال الملخص النهائي

### Frontend (React + Socket.io Client)

```
client/src/
├── hooks/useLiveCopilot.ts      # Hook للتعامل مع Socket.io
└── pages/LiveInterview.tsx      # واجهة المقابلة المباشرة
```

**الحالات المدارة:**
- `isConnected`: حالة الاتصال بالسيرفر
- `sessionId`: معرف الجلسة الحالية
- `transcript`: النص المباشر
- `suggestions`: الاقتراحات الفورية
- `redFlags`: العلامات الحمراء
- `isRecording`: حالة التسجيل

## كيفية الاستخدام

### 1. بدء جلسة جديدة

```typescript
const { startSession } = useLiveCopilot();

await startSession(
  userId,
  "أحمد محمد",        // اسم المرشح
  "مدير تسويق"        // المنصب
);
```

### 2. بدء التسجيل

```typescript
const { startRecording } = useLiveCopilot();

// تسجيل كلام المقابِل
await startRecording('interviewer');

// تسجيل كلام المرشح
await startRecording('candidate');
```

### 3. إيقاف التسجيل

```typescript
const { stopRecording } = useLiveCopilot();

stopRecording();
```

### 4. إنهاء الجلسة

```typescript
const { endSession } = useLiveCopilot();

endSession(); // يحفظ الجلسة ويولد الملخص
```

## تدفق البيانات

```
1. المستخدم يضغط "بدء التسجيل"
   ↓
2. المتصفح يلتقط الصوت (MediaRecorder)
   ↓
3. كل 5 ثوان، يتم إرسال chunk إلى السيرفر
   ↓
4. السيرفر يحفظ الصوت في S3
   ↓
5. السيرفر يحول الصوت إلى نص (Whisper)
   ↓
6. السيرفر يرسل النص إلى المتصفح
   ↓
7. إذا كان المتحدث هو المرشح:
   ├── السيرفر يحلل الإجابة بالذكاء الاصطناعي
   ├── يولد اقتراحات فورية
   ├── يكشف العلامات الحمراء
   └── يرسل كل شيء إلى المتصفح
   ↓
8. المستخدم يرى النص والاقتراحات فورًا
```

## المتطلبات

### Backend
- Socket.io 4.8+
- Whisper API (للتعرف الصوتي)
- DeepSeek/OpenAI API (للتحليل)
- S3 Storage (لحفظ الصوت)

### Frontend
- Socket.io Client 4.8+
- MediaRecorder API (مدعوم في جميع المتصفحات الحديثة)
- أذونات الميكروفون

## الأمان والخصوصية

1. **التشفير**: جميع الاتصالات عبر WebSocket مشفرة
2. **الأذونات**: يطلب إذن الميكروفون قبل التسجيل
3. **الخصوصية**: الصوت يحفظ بشكل آمن في S3 مع مفاتيح فريدة
4. **الحذف**: يمكن حذف جلسات المقابلة من قاعدة البيانات

## الأداء

- **Latency**: ~2-5 ثوان من نهاية الكلام حتى ظهور النص
- **Throughput**: يدعم عدة جلسات متزامنة
- **Scalability**: Socket.io يدعم clustering للتوسع

## استكشاف الأخطاء

### خطأ "Microphone permission denied"
- تأكد من منح إذن الميكروفون في المتصفح
- في Chrome: الإعدادات > الخصوصية والأمان > إعدادات الموقع > الميكروفون

### خطأ "Socket.io connection failed"
- تحقق من أن السيرفر يعمل
- تحقق من إعدادات CORS
- تحقق من أن Socket.io مفعّل في `server/_core/index.ts`

### خطأ "Transcription failed"
- تحقق من أن Whisper API key صحيح
- تحقق من حجم ملف الصوت (يجب أن يكون أقل من 25MB)
- تحقق من تنسيق الصوت (WebM/Opus مدعوم)

## التطوير المستقبلي

### ميزات مقترحة
1. **دعم اللغات المتعددة**: إضافة دعم للإنجليزية والفرنسية
2. **تحليل النبرة الصوتية**: كشف التوتر والثقة من نبرة الصوت
3. **تقارير مفصلة**: تقارير PDF قابلة للتحميل
4. **التكامل مع ATS**: التكامل مع أنظمة تتبع المتقدمين
5. **مقارنة المرشحين**: مقارنة تلقائية بين عدة مرشحين

## الدعم

للمساعدة أو الإبلاغ عن مشاكل:
- راجع logs السيرفر: `[LiveCopilot]` prefix
- راجع console المتصفح: `[LiveCopilot]` prefix
- تحقق من حالة Socket.io: `isConnected` state

---

**ملاحظة**: هذه ميزة متقدمة تتطلب موارد كبيرة (Whisper API + LLM API). استخدمها بحكمة.
